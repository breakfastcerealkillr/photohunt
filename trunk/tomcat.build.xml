
<project name="tomcat" default="tomcat.deploy">
  <description>
  Provides tasks to deploy and undeploy this webapp to Tomcat. 
  </description>
  
  <import file="jar.build.xml"/>
  
  <!-- Default values. Override on command line with -D -->
  <property name="tomcat.admin.user" value="admin"/>
  <property name="tomcat.admin.password" value="changethis"/>
  
  <target name="tomcat.install" depends="jar">
    <copy todir="${build.dir}/war">
      <fileset dir="${basedir}/webapp"/>
    </copy>
    <copy todir="${build.dir}/war/" file="${basedir}/webapp/Footer.jsp" overwrite="yes">
      <filterset>
        <filter token="version" value="${version}"/>
        <filter token="buildtime" value="${buildtime}"/>
      </filterset>
    </copy> 
      
    <copy todir="${build.dir}/war/WEB-INF" file="${basedir}/webapp/WEB-INF/web.xml" overwrite="yes">
    </copy>
      
    <copy todir="${build.dir}/war/WEB-INF/lib" file="${build.dir}/photohunt.jar"/> 
  </target>

  <target name="tomcat.check">
    <!-- First ensure that Tomcat is actually up. -->
    <condition property="tomcat.ok">
      <http url="${test.host}"/>
    </condition>
    <fail unless="tomcat.ok" message="Tomcat does not appear to be running on ${test.host}"/>
    <!-- Tomcat is up, so now check that we have access to the manager. -->
    <get src="${test.host}/manager/list"
         dest="list-results.tmp"
         username="${tomcat.admin.user}"
         password="${tomcat.admin.password}"/>
    <loadfile property="list.results" srcFile="list-results.tmp"/>
    <condition property="tomcat.manager.ok">
      <contains string="${list.results}" substring="OK"/>
    </condition>
    <fail unless="tomcat.manager.ok" message="Tomcat manager not accessable on ${test.host}"/>
    <delete file="list-results.tmp"/>
    <echo message="Tomcat and its management interface contacted successfully."/>
  </target>

  <target name="tomcat.deploy" depends="tomcat.check, tomcat.undeploy, tomcat.install">
    <echo message="Starting hot deployment to ${system.name}." />
    <property name="deploy.params" value="path=/${system.name}&amp;war=${build.dir}/war" />
    <property name="deploy.install.url" value="${test.host}manager/deploy" />
    <get src="${deploy.install.url}?${deploy.params}" dest="install-results.tmp" username="${tomcat.admin.user}" password="${tomcat.admin.password}" />
    <loadfile property="install.results" srcFile="install-results.tmp" />
    <echo level="info" message="Install results: ${install.results}"/>
    <delete file="install-results.tmp" />
  </target>

  <target name="tomcat.undeploy">
    <property name="deploy.remove.url"  value="${test.host}/manager/undeploy"/>
    <get src="${deploy.remove.url}?path=/${system.name}"
         dest="remove-results.tmp"
         username="${tomcat.admin.user}"
         password="${tomcat.admin.password}"/>
    <loadfile property="remove.results" srcFile="remove-results.tmp"/>
    <echo>${remove.results}</echo>
    <delete file="remove-results.tmp"/>
  </target>

</project>